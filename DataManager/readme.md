# [DataManager] ë°ì´í„° ì €ì¥ ê³¼ì •ì˜ ê°œì„ 

## ê°œìš”

- TodangTodang êµ¬í˜„ì‚¬í•­ ì¤‘ DataManagerì— ëŒ€í•œ êµ¬í˜„/ê°œì„  ì‚¬í•­ì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤.
- ì‚¬ìš© ê¸°ìˆ 
    - ì˜µì €ë²„ íŒ¨í„´
    - ì œë„¤ë¦­ ë©”ì†Œë“œ

<br>
<br>

## âš ï¸ ê°œì„  ë°°ê²½

![Untitled](Image/Untitled.png)
- ì €ì¥í•´ì•¼ í•  ë°ì´í„°ê°€ ì¶”ê°€ë  ë•Œ ë§ˆë‹¤ DataManagerì— ë°ì´í„° ì €ì¥/ë¡œë“œ ë©”ì†Œë“œë¥¼ ë§Œë“¬
- ë°ì´í„°ê°€ ìƒˆë¡œ ìƒì„±ë  ë•Œë§ˆë‹¤ DataManagerë¥¼ ìˆ˜ì •í•´ì•¼í•¨
- ë¹„ìŠ·í•œ êµ¬ì¡°ì˜ ì½”ë“œì˜ ë°˜ë³µì´ ì¼ì–´ë‚¨

<br>
<br>

## ğŸ¤” ê°œì„  ê³¼ì •

- ì—¬ëŸ¬ ê°œì˜ ì½”ë“œê°€ ì•„ë‹Œ í•œ ê°œì˜ ì½”ë“œë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ë°©ì•ˆì€ ì œë„¤ë¦­ ë©”ì†Œë“œê°€ ì í•©í•˜ë‹¤ê³  íŒë‹¨.
- ì¶”ê°€ì ìœ¼ë¡œ ì˜µì €ë²„ íŒ¨í„´ì„ í™œìš©í•˜ê²Œ ëœë‹¤ë©´, ì €ì¥ ëŒ€ìƒ DataManagerì— êµ¬ë…ì„ ë“±ë¡í•˜ê³  <br>
  DataManagerëŠ” êµ¬ë…ëœ í´ë˜ìŠ¤ë“¤ë¡œ ë¶€í„° JsonDataë¥¼ ë°›ì•„ ì €ì¥í•˜ëŠ” í•˜ëŠ” í˜•íƒœ<br>

- ë‹¤ë§Œ Loadê³¼ì •ì€ JsonDataë¥¼ í†µí•˜ê³  ì‹¶ì—ˆì§€ë§Œ, ê¸°ë³¸ ë°ì´í„°ë¥¼ DataManagerì—ì„œ ê´€ë¦¬í•˜ê³  ìˆì–´, ê°ê°ì˜ data ìì‹ í´ë˜ìŠ¤ì—ì„œ ì°¸ì¡°í•˜ëŠ” ê²ƒì€ ì½”ë“œì˜ ê²°í•©ë„ë¥¼ ë†’ì´ëŠ” ê²°ê³¼ë¼ê³  íŒë‹¨,
- Loadê³¼ì •ì—ì„œëŠ” DataManagerì—ì„œ ê°ê°ì˜ Dataë¥¼ ì§ì ‘ ë°˜í™˜í•´ì£¼ëŠ” ê²ƒìœ¼ë¡œ ê²°ì •
- ì´ë•Œ ì œë„¤ë¦­ ë©”ì†Œë“œë¥¼ ì´ìš©, ì½”ë“œë¥¼ í•˜ë‚˜ë¡œ ë¬¶ì–´ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´
ì½”ë“œ ìˆ˜ì •ì„ êµ­ì†Œì ìœ¼ë¡œ í•´ë„ ë˜ë„ë¡ ìˆ˜ì •í•¨.

<br>
<br>

## ğŸ’¡ ê°œì„  í›„ ì–»ì€ ì´ì 
- DataManagerì—ì„œ ë°ì´í„° ë³„ë¡œ ë°˜ë³µë˜ë˜ ì½”ë“œë¥¼ ì¤„ì¼ ìˆ˜ ìˆì—ˆìŒ. 817 -> 695ì¤„
- ë°ì´í„° ì¶”ê°€ ì‹œ Load ê´€ë ¨ 2ê°œì˜ ë©”ì†Œë“œì™€, DefaultData ì´ˆê¸°í™” ë¶€ë¶„ì— ëŒ€í•œ ì¶”ê°€ë§Œ í•˜ë©´ ë°ì´í„° ì¶”ê°€ ê°€ëŠ¥
- Saveì˜ ê²½ìš°ì—” ë°ì´í„° ìª½ì—ì„œ JsonDataë¥¼ ìƒì„±í•´ì„œ ë³´ë‚´ì£¼ê¸° ë•Œë¬¸ì— DataManagerì—ì„œëŠ” ìˆ˜ì • ë¶ˆí•„ìš”

<br>
<br>

## êµ¬í˜„ ì‚¬í•­

![Untitled](Image/Untitled%201.png)

### Saveê³¼ì •

- Savable ë¼ëŠ” Base í´ë˜ìŠ¤ë¥¼ ë‘ê³ , Baseí´ë˜ìŠ¤ëŠ” ì˜µì €ë²„ì˜ ì—­í• ì„ ë‹´ë‹¹,
- Savable ë¥¼ ìƒì†í•˜ëŠ” í´ë˜ìŠ¤ëŠ” ìë™ìœ¼ë¡œ DataManagerì— êµ¬ë…ìš”ì²­
- DataManagerëŠ” ì™¸ë¶€ì˜ ì €ì¥ ìš”ì²­ì´ ìˆì„ ë•Œ êµ¬ë…ëœ Savable HashSetì— JsonDataë¥¼ ìš”ì²­
- ê°ê°ì˜ Dataì—ì„œ JsonDataë¥¼ ì¶”ì¶œí•´ DataManagerë¡œ ë°˜í™˜
- ê°€ì ¸ì˜¨ JsonDataë¥¼ ë°”íƒ•ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì €ì¥(ì•”í˜¸í™”, ë¬´ê²°ì„± ê²€ì¦ ë°ì´í„° ì‚½ì…)

### ê´€ë ¨ ì½”ë“œ

Savable.cs

```csharp
public abstract class Savable
{
    private DataManager _dataManager;

    public Savable()
    {
        _dataManager = DataManager.Instance;
#if UNITY_EDITOR
        Debug.Assert(_dataManager, $"dataManager {Strings.DebugLog.INIT_PROBLEM} ");
#endif

        _dataManager.RegistSaveData(this);
    }

    public abstract void Init(string json, Param saveParam = null);
    public abstract string GetJsonData();

    ~Savable()
    {
        _dataManager.CancelRegistSaveData(this);
    }
}
```

DataManager.cs ì¤‘ Save ê´€ë ¨ë‚´ìš©

```csharp

public void RegistSaveData(Savable saveData)
{
    _saveDatas.Add(saveData);
}

public void CancelRegistSaveData(Savable saveData)
{
    _saveDatas.Remove(saveData);
}

private void Save(string data, string path)
{
    using (StreamWriter sr = new StreamWriter(path))
    {
        string encryptingData = EncryptData(data);
        string versionAddedData = $"{Strings.SaveData.SAVE_VERSION}|{encryptingData}";
        string hashString = versionAddedData.GetHashCode().ToString();
        sr.Write($"{Strings.SaveData.SAVE_VERSION}|{encryptingData}|{hashString}");
    }
}

public void SaveAllData()
{
    foreach (Savable data in _saveDatas)
    {
        Type type = data.GetType();
        if (_filePathDic.TryGetValue(type, out string filePath))
        {
            string jsonData = data.GetJsonData();
            Save(jsonData,filePath);
        }
        else
        {   
#if UNITY_EDITOR
            Debug.LogWarning(Strings.Path.NONE_PATH);
#endif
        }       
    }
}
```

MarketData.cs ì¤‘ JsonData ë°˜í™˜ ì½”ë“œ
```csharp
public override string GetJsonData()
{
    MarketSaveData marketSaveData = new MarketSaveData();
    marketSaveData.IngredientPriceStrs = new List<string>();
    marketSaveData.IngredientPriceValues= new List<int>();
    marketSaveData.IsSellableStrs = new List<string>();
    marketSaveData.IsSellableValues = new List<bool>();
    foreach (KeyValuePair<string, int> pricesKeyValue in GetIngredientPrices())
    {
        marketSaveData.IngredientPriceStrs.Add(pricesKeyValue.Key);
        marketSaveData.IngredientPriceValues.Add(pricesKeyValue.Value);
    }
    
    foreach (KeyValuePair<string, bool> sellableKeyValue in GetIsSellableDatas())
    {
        marketSaveData.IsSellableStrs.Add(sellableKeyValue.Key);
        marketSaveData.IsSellableValues.Add(sellableKeyValue.Value);
    }
    
    string jsonData = JsonUtility.ToJson(marketSaveData);
    return jsonData;
}
```
<br>
<br>

---

<br>
<br>

### Loadê³¼ì •
- GameManagerì—ì„œ Loadìš”ì²­ì„ ìˆ˜í–‰í•˜ê³ , ì´ë•Œ ì œë„¤ë¦­ ë©”ì†Œë“œë¡œ ì ‘ê·¼í•˜ì—¬ ë°ì´í„°ë¥¼ ê°€ì ¸ê°

### ê´€ë ¨ ì½”ë“œ

- DataManager.csì˜ Load ê³¼ì •
 ```csharp
public void LoadData<T>(out T data) where T : Savable, new()
{
    Type dataType = typeof(T);
    data = null;
    string jsonData = null;
    if (_filePathDic.TryGetValue(dataType, out string filePath) && File.Exists(filePath))
    {
        jsonData = Load(filePath,out bool needEncrypt);
        
        if (jsonData == string.Empty || isCorrupted)
        {
            GetDefaultData<T>(dataType, out data);
        }
        else
        {
            data = new T();
						Param param = GetParam<T>();
            data.Init(jsonData,param);                
        }
        if (needEncrypt)
        {
            Save(jsonData,filePath);
        }
    }
    else
    {   
#if UNITY_EDITOR
        if(filePath == null)
            Debug.LogWarning("typeì— ë§ëŠ” filePathê°€ ì—†ìŠµë‹ˆë‹¤. ì‹ ê²½ì¨ì£¼ì„¸ìš”");
#endif
        GetDefaultData<T>(dataType, out data);
    }
}


private string Load(string path, out bool needEncrypt)
{
    string data = string.Empty;
    needEncrypt = false;
    using (StreamReader sr = new StreamReader(path))
    {
        string encrypdata = sr.ReadToEnd();
        // ì¶”í›„ì— ë²„ì „ ì²´í¬ë¥¼ í•  ìˆ˜ ìˆê²Œ ë³€í˜•í•  ìˆ˜ ìˆìŒ.
        if (encrypdata.StartsWith(Strings.SaveData.SAVE_VERSION))
        {
            string[] splited = encrypdata.Split("|");
            if (splited.Length != 3)
            {
                isCorrupted = true;
                Debug.LogWarning(Strings.Data.);
                return string.Empty;
            }
            else
            {
                string hashString = $"{splited[0]}|{splited[1]}";
                int hash;
                if (int.TryParse(splited[2],out hash)&& hash == hashString.GetHashCode())
                {
                    data = DecryptData(splited[1]);
                }
                else
                {
                    isCorrupted = true;
                    Debug.LogWarning("ë°ì´í„°ì˜ ì´ìƒ");
                    return string.Empty;
                }
            }
        }
        else if ( encrypdata.StartsWith("{"))
        {
            data = encrypdata;
            needEncrypt = true;
        }
        else
        {
            isCorrupted = true;
            Debug.LogWarning("ë°ì´í„°ì˜ ì´ìƒ");
            return string.Empty;
        }
        
    }
    return data;
}

private void GetDefaultData<T>(Type dataType, out T data) where T : Savable
{
    data = null;
    if (dataType == typeof(PlayerData))
    {
        data = MakeDefaultPlayerData() as T;
    }
    else if(dataType == typeof(MarketData))
    {
        IngredientInfoSO[] ingredientInfoSos = GetDefaultDataArray<IngredientInfoSO>();
        data = MakeDefaultMarketData(ingredientInfoSos) as T;
    }
    else if(dataType == typeof(DecoStoreData))
    {
        data = MakeDefaultDecoStoreData() as T;
    }
    else if (dataType == typeof(NewsSystem))
    {
        data = new NewsSystem() as T;
    }
}

private Param GetParam<T>()
{
    Param data = null;
    Type dataType = typeof(T);
    if(dataType == typeof(MarketData))
    {
        MarketData.MarketDataParam param = new MarketData.MarketDataParam();
        IngredientInfoSO[] ingredientInfoSos = GetDefaultDataArray<IngredientInfoSO>();
        param.IngredientInfoSos = ingredientInfoSos;
        data = param;
    }
    else if(dataType == typeof(DecoStoreData))
    {
        DecoStoreData.DecoStoreDataParam param = new DecoStoreData.DecoStoreDataParam();
        StoreDecorationInfoSO[] storeDecorationInfoSos = GetDefaultDataArray<StoreDecorationInfoSO>();
        param._storeDecoDatas = storeDecorationInfoSos;
        data = param;
    }

    return data;
}

// ê°ê°ì˜ SaveDataë“¤ì´ ìì‹ ì˜ ì´ˆê¸°í™” ë³€ìˆ˜ë¥¼ ë‹´ê¸° ìœ„í•¨
public abstract class Param 
{
    
}
``` 
MarketData.cs(ë¡œë“œë˜ëŠ” ë°ì´í„° ì¤‘ í•˜ë‚˜)<br>
Init : JsonDataë°ì´í„°ê°€ ìˆì„ ë•Œ ë¡œë“œ ì‹œ ì‚¬ìš©<br>
GetJson : ì €ì¥ ì‹œ JsonData ë°˜í™˜

```csharp
public override void Init(string json, Param saveParam = null)
{
    MarketDataParam marketDataParam = saveParam as MarketDataParam;
    MarketSaveData data = JsonUtility.FromJson<MarketSaveData>(json);
    _ingredientInfoList = marketDataParam.IngredientInfoSos;

    if (data != null)
    {
        for (int i = 0; i < data.IngredientPriceStrs.Count; ++i)
        {
            _ingredientPrices.Add(data.IngredientPriceStrs[i],data.IngredientPriceValues[i]);
            _isSellable.Add(data.IsSellableStrs[i],data.IsSellableValues[i]);
        }
    }
}

public class MarketDataParam : Param
{
    public IngredientInfoSO[] IngredientInfoSos;
}
```

<br>
<br>

## ê°œì„  ë” í•„ìš”í•œ ì‚¬í•­

### DataManagerì˜ ê³¼ë„í•œ ì—­í• 
  - í˜„ì¬ êµ¬ì¡°ëŠ” DataManagerê°€ SOì™€ ê°™ì€ ê¸°ë³¸ ë°ì´í„°ë“¤ì„ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ê³¼ Save/Load ê¸°ëŠ¥ì„ í¬í•¨í•˜ê³  ìˆëŠ” í´ë˜ìŠ¤ì„
  - ë‘ ê°œë¥¼ ë¶„ë¦¬í•´ì„œ DataManagerëŠ” ê¸°ë³¸ë°ì´í„°ì˜ ê´€ë¦¬ë§Œ, SaveAndLoadëŠ”  Saveì™€ Loadê¸°ëŠ¥ë§Œ ê´€ë¦¬í•˜ê²Œ í•˜ê³ , ê°ê°ì´ ë”°ë¡œ BaseClassë‚˜ Interfaceì—ì„œ ì ‘ê·¼í•˜ë„ë¡ ì„¤ê³„ë¥¼ í•´ ë†“ëŠ”ë‹¤ë©´, ê¸°ë³¸ ë°ì´í„°ì™€ SaveAndLoad ë¶€ë¶„ ê°„ ê²°í•©ë„ë¥¼ ë‚®ì¶œ ìˆ˜ ìˆì–´, êµ¬ì¡°ì ìœ¼ë¡œ ì¢‹ì•˜ì„ ê²ƒì„.

### Savableì™€ DataManagerì˜ ê´€ê³„
  - Savableì—ì„œ Saveì™€ Loadë¥¼ string ë°ì´í„°ë§Œì„ ì´ìš©í•´ êµ¬í˜„í•˜ê²Œ í•œë‹¤ë©´, ì§€ê¸ˆë³´ë‹¤ ë” ê°„ë‹¨í•œ êµ¬ì¡°ì˜ Save/Load ì‹œìŠ¤í…œì´ ì™„ì„±ë˜ì—ˆì„ ê²ƒì„
  - stringë§Œì„ ì‚¬ìš©í•˜ê¸°ì— ì§€ê¸ˆ êµ¬ì¡°ì™€ ë‹¤ë¥´ê²Œ ì œë„¤ë¦­ ë©”ì†Œë“œ ì—†ì´ êµ¬í˜„ì´ ê°€ëŠ¥í•˜ê²Œ ë¨
  - ì´ì— ë”°ë¼ DataManagerì—ì„œëŠ” ìˆ˜ì • ì—†ì´ ì €ì¥ ë°ì´í„°ë¥¼ ê³„ì†í•´ì„œ í¬í•¨í•  ìˆ˜ ìˆê²Œë¨.
  - ì´ë¥¼ í†µí•´ ê°„ë‹¨í•˜ë©´ì„œë„, ì½”ë“œ ê°€ë…ì„± ì¦ëŒ€ ë°, ì €ì¥ ë°ì´í„°ì˜ ì¶”ê°€/ì‚­ì œì— ì˜í–¥ ì „í˜€ ì—†ëŠ” DataManagerê°€ ë˜ì—ˆì„ ê²ƒì„.